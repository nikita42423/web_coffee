{% extends 'base.html' %}
{% load static %}

{% block title %}{{ film.title }} - —Å–º–æ—Ç—Ä–µ—Ç—å –æ–Ω–ª–∞–π–Ω{% endblock %}

{% block extra_css %}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–∏–ª—å–º–∞ */
    .film-detail {
        background: #141414;
        min-height: 100vh;
    }
    
    /* —Ñ–æ–Ω */
    .film-backdrop {
        height: 70vh;
        background-size: cover;
        background-position: center 20%;
        position: relative;
    }
    
    .film-backdrop::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 200px;
        background: linear-gradient(to top, #141414, transparent);
    }
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .film-content {
        max-width: 1200px;
        margin: -200px auto 0;
        padding: 0 20px;
        position: relative;
        z-index: 10;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 40px;
    }
    
    /* –ü–æ—Å—Ç–µ—Ä */
    .film-poster-large {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    .film-poster-large img {
        width: 100%;
        display: block;
    }
    
    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–ª—å–º–µ */
    .film-info {
        color: white;
    }
    
    .film-title-large {
        font-size: 2.5em;
        margin: 0 0 10px 0;
    }
    
    .film-title-original {
        color: #b3b3b3;
        margin-bottom: 20px;
    }
    
    .film-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .meta-item {
        background: #2a2a2a;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
    }
    
    .accessibility-badges {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .access-badge {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    
    .badge-subtitles {
        background: #00a8e1;
    }
    
    .badge-sign {
        background: #8e44ad;
    }
    
    .badge-audio {
        background: #27ae60;
    }
    
    .film-description {
        line-height: 1.8;
        margin-bottom: 30px;
        color: #e0e0e0;
    }
    
    .film-actions {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .watch-btn {
        background: #e50914;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 4px;
        font-size: 1.1em;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }
    
    .watch-btn:hover {
        background: #f40612;
    }
    
    .info-btn {
        background: #2a2a2a;
        color: white;
        padding: 12px 30px;
        border-radius: 4px;
        text-decoration: none;
    }
    
    /* –î–µ—Ç–∞–ª–∏ */
    .film-details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 40px;
        background: #1f1f1f;
        padding: 20px;
        border-radius: 8px;
    }
    
    .detail-item {
        color: #b3b3b3;
    }
    
    .detail-label {
        font-weight: bold;
        color: white;
        margin-right: 10px;
    }
    
    /* –í–∏–¥–µ–æ–ø–ª–µ–µ—Ä */
    .video-section {
        background: #1f1f1f;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 40px;
    }
    
    .video-player-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
    }
    
    .video-player-wrapper iframe,
    .video-player-wrapper video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .video-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        border-bottom: 1px solid #2a2a2a;
        padding-bottom: 15px;
    }
    
    .video-tab {
        padding: 10px 20px;
        background: #2a2a2a;
        color: #b3b3b3;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .video-tab:hover {
        background: #3a3a3a;
        color: white;
    }
    
    .video-tab.active {
        background: #e50914;
        color: white;
    }
    
    .video-tab.primary {
        position: relative;
    }
    
    .video-tab.primary::after {
        content: '‚≠ê';
        margin-left: 5px;
        font-size: 0.8em;
    }
    
    .video-meta {
        display: flex;
        gap: 20px;
        padding: 15px;
        background: #2a2a2a;
        border-radius: 4px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 15px;
    }
    
    .badge-sub {
        background: #00a8e1;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    .badge-sign {
        background: #8e44ad;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    .badge-quality {
        background: #27ae60;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    .no-video {
        text-align: center;
        padding: 100px 20px;
        background: #2a2a2a;
        border-radius: 8px;
        color: #666;
    }
    
    /* –°–µ–∑–æ–Ω—ã –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤ */
    .seasons-section {
        background: #1f1f1f;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 40px;
    }
    
    .season-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .season-btn {
        padding: 8px 16px;
        background: #2a2a2a;
        color: #b3b3b3;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .season-btn.active {
        background: #e50914;
        color: white;
    }
    
    .episodes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .episode-card {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .episode-card:hover {
        background: #333;
        transform: scale(1.02);
    }
    
    .episode-title {
        font-weight: bold;
        color: white;
        margin-bottom: 5px;
    }
    
    .episode-meta {
        color: #b3b3b3;
        font-size: 0.9em;
    }
    
    /* –ü–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã */
    .similar-section {
        margin-top: 40px;
    }
    
    .similar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 20px;
    }
    
    .similar-item {
        background: #1f1f1f;
        border-radius: 4px;
        overflow: hidden;
        transition: all 0.3s;
        text-decoration: none;
    }
    
    .similar-item:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .film-content {
            grid-template-columns: 1fr;
            margin-top: -100px;
        }
        
        .film-poster-large {
            max-width: 300px;
            margin: 0 auto;
        }
        
        .video-tabs {
            flex-direction: column;
        }
        
        .video-tab {
            width: 100%;
            justify-content: center;
        }
        
        .film-details-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="film-detail">
    {% if film.backdrop %}
        <div class="film-backdrop" style="background-image: url('{{ film.backdrop.url }}')"></div>
    {% else %}
        <div class="film-backdrop" style="background: linear-gradient(135deg, #1a1a1a, #2a2a2a)"></div>
    {% endif %}
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="film-content">
        <div class="film-poster-large">
            {% if film.poster %}
                <img src="{{ film.poster.url }}" alt="{{ film.title }}">
            {% else %}
                <div style="background: #2a2a2a; height: 450px; display: flex; align-items: center; justify-content: center; font-size: 3em;">
                    üé¨
                </div>
            {% endif %}
        </div>
        
        <div class="film-info">
            <h1 class="film-title-large">{{ film.title }}</h1>
            {% if film.original_title %}
                <div class="film-title-original">{{ film.original_title }}</div>
            {% endif %}
            
            <div class="film-meta">
                <span class="meta-item">{{ film.get_content_type_display }}</span>
                <span class="meta-item">{{ film.year }}</span>
                <span class="meta-item">{{ film.duration }} –º–∏–Ω</span>
                <span class="meta-item">{{ film.age_rating }}</span>
                {% if film.imdb_rating %}
                    <span class="meta-item">IMDB: {{ film.imdb_rating }}</span>
                {% endif %}
            </div>
            
            <div class="accessibility-badges">
                {% if film.has_subtitles %}
                    <span class="access-badge badge-subtitles">üìù –°—É–±—Ç–∏—Ç—Ä—ã</span>
                {% endif %}
                {% if film.has_sign_language %}
                    <span class="access-badge badge-sign">ü§ü –ñ–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥</span>
                {% endif %}
                {% if film.has_audio_description %}
                    <span class="access-badge badge-audio">üéß –ê—É–¥–∏–æ–æ–ø–∏—Å–∞–Ω–∏–µ</span>
                {% endif %}
            </div>
            
            <div class="film-actions">
                <a href="#player-section" class="watch-btn" onclick="document.getElementById('player-section').scrollIntoView({behavior: 'smooth'})">
                    ‚ñ∂ –°–º–æ—Ç—Ä–µ—Ç—å
                </a>
                <button class="info-btn">‚ûï –í —Å–ø–∏—Å–æ–∫</button>
            </div>
            
            <div class="film-description">
                {{ film.description|linebreaks }}
            </div>
            
            <div class="film-details-grid">
                <div class="detail-item">
                    <span class="detail-label">–†–µ–∂–∏—Å—Å–µ—Ä—ã:</span>
                    {% for director in film.directors.all %}
                        {{ director.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
                <div class="detail-item">
                    <span class="detail-label">–í —Ä–æ–ª—è—Ö:</span>
                    {% for actor in film.actors.all|slice:":5" %}
                        {{ actor.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
                <div class="detail-item">
                    <span class="detail-label">–°—Ç—Ä–∞–Ω–∞:</span>
                    {% for country in film.countries.all %}
                        {{ country.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
                <div class="detail-item">
                    <span class="detail-label">–ñ–∞–Ω—Ä—ã:</span>
                    {% for genre in film.genres.all %}
                        <a href="{% url 'films:list' %}?genre={{ genre.slug }}" style="color: #e50914; text-decoration: none;">
                            {{ genre.name }}
                        </a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- –í–ò–î–ï–û–ü–õ–ï–ï–† -->
    <div id="player-section" style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
        <div class="video-section">
            <!-- –í–∫–ª–∞–¥–∫–∏ —Å –≤–∏–¥–µ–æ -->
            {% if film.videos.all %}
            <div class="video-tabs">
                {% for video in film.videos.all %}
                <button class="video-tab {% if forloop.first %}active{% endif %} {% if video.is_primary %}primary{% endif %}" 
                        onclick="showVideo({{ video.id }})">
                    {% if video.platform == 'local' %}üìÅ{% endif %}
                    {% if video.platform == 'youtube' %}‚ñ∂{% endif %}
                    {% if video.platform == 'vk' %}üì±{% endif %}
                    {% if video.platform == 'rutube' %}üîÑ{% endif %}
                    {% if video.platform == 'iframe' %}üîó{% endif %}
                    {{ video.title|default:video.get_platform_display }}
                </button>
                {% endfor %}
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –≤–∏–¥–µ–æ -->
            <div class="video-containers">
                {% for video in film.videos.all %}
                <div id="video-{{ video.id }}" class="video-container" 
                     style="display: {% if forloop.first %}block{% else %}none{% endif %};">
                    
                    <!-- –ü–ª–µ–µ—Ä -->
                    <div class="video-player-wrapper">
                        {% if video.embed_code %}
                            {{ video.embed_code|safe }}
                        {% elif video.platform == 'youtube' and video.youtube_id %}
                            <iframe src="https://www.youtube.com/embed/{{ video.youtube_id }}" 
                                    frameborder="0" 
                                    allowfullscreen>
                            </iframe>
                        {% elif video.platform == 'vk' and video.vk_id %}
                            <iframe src="https://vkvideo.ru/video_ext.php?oid={{ video.vk_owner_id|default:'' }}&id={{ video.vk_id }}&hash=3ac5b93799aaa07d" 
                                    frameborder="0" 
                                    allowfullscreen="1" 
                                    allow="autoplay; encrypted-media; fullscreen; picture-in-picture">
                            </iframe>
                        {% elif video.video_file %}
                            <video controls>
                                <source src="{{ video.video_file.url }}" type="video/mp4">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                            </video>
                        {% else %}
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #1a1a1a; color: #666;">
                                <p>–í–∏–¥–µ–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ -->
                    <div class="video-meta">
                        {% if video.quality %}
                            <span class="badge-quality">üì∫ {{ video.quality }}</span>
                        {% endif %}
                        {% if video.language %}
                            <span>üó£ {{ video.language }}</span>
                        {% endif %}
                        {% if video.has_subtitles %}
                            <span class="badge-sub">üìù –°—É–±—Ç–∏—Ç—Ä—ã</span>
                        {% endif %}
                        {% if video.has_sign_language %}
                            <span class="badge-sign">ü§ü –ñ–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥</span>
                        {% endif %}
                        {% if video.is_primary %}
                            <span style="color: gold;">‚≠ê –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-video">
                <h3>üé¨ –í–∏–¥–µ–æ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</h3>
                <p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–∏—Ç –≤–∏–¥–µ–æ –ø–æ–∑–∂–µ</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- –°–µ–∑–æ–Ω—ã –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤ -->
    {% if film.content_type == 'series' and film.episodes_list.all %}
    <div style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
        <div class="seasons-section">
            <h3 style="color: white; margin-bottom: 20px;">üì∫ –°–µ–∑–æ–Ω—ã –∏ —Å–µ—Ä–∏–∏</h3>
            
            {% regroup film.episodes_list.all by season as seasons_list %}
            
            <div class="season-selector">
                {% for season in seasons_list %}
                <button class="season-btn {% if forloop.first %}active{% endif %}" 
                        onclick="showSeason({{ season.grouper }})">
                    –°–µ–∑–æ–Ω {{ season.grouper }}
                </button>
                {% endfor %}
            </div>
            
            {% for season in seasons_list %}
            <div id="season-{{ season.grouper }}" class="season-container" 
                 style="display: {% if forloop.first %}block{% else %}none{% endif %};">
                <div class="episodes-grid">
                    {% for episode in season.list %}
                    <div class="episode-card" onclick="playEpisode({{ episode.id }})">
                        <div class="episode-title">
                            {{ episode.episode }}. {{ episode.title|default:"–°–µ—Ä–∏—è" }}
                        </div>
                        <div class="episode-meta">
                            {% if episode.duration %}
                                ‚è± {{ episode.duration }} –º–∏–Ω
                            {% endif %}
                            {% if episode.release_date %}
                                üìÖ {{ episode.release_date|date:"d.m.Y" }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- –ü–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã -->
    {% if similar_films %}
    <section style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
        <h2 style="color: white; margin-bottom: 20px;">üé¨ –ü–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã</h2>
        <div class="similar-grid">
            {% for film in similar_films %}
            <a href="{% url 'films:detail' film.slug %}" class="similar-item">
                {% if film.poster %}
                    <img src="{{ film.poster.url }}" alt="{{ film.title }}" style="width: 100%; aspect-ratio: 2/3; object-fit: cover;">
                {% else %}
                    <div style="aspect-ratio: 2/3; background: #2a2a2a; display: flex; align-items: center; justify-content: center;">
                        üé¨
                    </div>
                {% endif %}
                <div style="padding: 10px;">
                    <div style="color: white; font-weight: bold;">{{ film.title }}</div>
                    <div style="color: #b3b3b3; font-size: 0.9em;">{{ film.year }}</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<!-- JavaScript -->
<script>
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∏–¥–µ–æ
function showVideo(videoId) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∏–¥–µ–æ
    document.querySelectorAll('[id^="video-"]').forEach(container => {
        container.style.display = 'none';
    });
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —Ç–∞–±–æ–≤
    document.querySelectorAll('.video-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
    document.getElementById('video-' + videoId).style.display = 'block';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É —Ç–∞–±—É
    event.target.classList.add('active');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–æ–≤
function showSeason(season) {
    document.querySelectorAll('[id^="season-"]').forEach(container => {
        container.style.display = 'none';
    });
    
    document.querySelectorAll('.season-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById('season-' + season).style.display = 'block';
    event.target.classList.add('active');
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–µ—Ä–∏–∏
function playEpisode(episodeId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Ä–∏–∏
    console.log('Play episode:', episodeId);
    alert('–§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Å–µ—Ä–∏–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–∏–¥–µ–æ –∏–∑ URL (–µ—Å–ª–∏ –µ—Å—Ç—å hash)
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash === '#player-section') {
        document.getElementById('player-section').scrollIntoView({behavior: 'smooth'});
    }
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –≤ localStorage
document.querySelectorAll('.video-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        localStorage.setItem('lastVideo', this.textContent.trim());
    });
});
</script>
{% endblock %}